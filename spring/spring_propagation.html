<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>spring事务传播性</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="vdar" id="spring事务传播性">spring事务传播性</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="4zy2" id="propagationrequired">PROPAGATION_REQUIRED</h2><div class="md-section-divider"></div><h3 data-anchor-id="11xq" id="简介">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qf2l"><ol class="linenums"><li class="L0"><code><span class="pun">加入当前已有事务；只有当前没有事务才启一个新的事务</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="a0u3" id="设计">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6ymb"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="uqx3" id="案例">案例</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wmfv"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，分配一个新事务。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），发现已经运行在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的事务内部，就不再启新的事务，而使用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">事务。</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="or4d" id="总结">总结</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="17ky"><ol class="linenums"><li class="L0"><code><span class="pun">在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">或者在</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">内的任何地方出现异常，</span><span class="lit">2</span><span class="pun">个方法内部的操作，都会被事务回滚。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="q0hk" id="propagationsupports">PROPAGATION_SUPPORTS</h2><div class="md-section-divider"></div><h3 data-anchor-id="exzb" id="简介-1">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rkri"><ol class="linenums"><li class="L0"><code><span class="pun">如果当前在事务中，即以事务的形式运行，如果当前不在一个事务中，那么就以非事务的形式运行</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="kyoy" id="设计-1">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="s3ma"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_SUPPORTS</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="0wk9" id="案例1">案例1</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="gyts"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，分配一个新事务。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），发现已经运行在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的事务内部，继续使用事务运行。</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="oy1n" id="案例2">案例2</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="frvq"><ol class="linenums"><li class="L0"><code><span class="pun">直接调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">，发现没有运行在事务中，使用非事务运行。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="icqz" id="propagationmandatory">PROPAGATION_MANDATORY</h2><div class="md-section-divider"></div><h3 data-anchor-id="n3td" id="简介-2">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="572l"><ol class="linenums"><li class="L0"><code><span class="pun">支持当前事务，如果当前没有事务，就抛出异常</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="4ou2" id="设计-2">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3gze"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_NOT_SUPPORTED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_MANDATORY</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="0ale" id="案例-1">案例</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="2k64"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，以非事务运行。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），发现已经运行在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的没有事务，抛出异常。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="b3cr" id="propagationrequiresnew">PROPAGATION_REQUIRES_NEW</h2><div class="md-section-divider"></div><h3 data-anchor-id="7kv3" id="简介-3">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="s9ix"><ol class="linenums"><li class="L0"><code><span class="pun">新建事务，如果当前存在事务，把当前事务挂起</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="8ctj" id="设计-3">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="4wj3"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRES_NEW</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="snlg" id="案例-2">案例</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="846j"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，分配一个新事务。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），当执行到</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">的时候，</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">事务就会挂起，</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">启一个新的事务，等待</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">的事务完成以后，</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的事务才继续执行。</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="e9y4" id="总结-1">总结</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qon3"><ol class="linenums"><li class="L0"><code><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">已经提交，那么</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">失败回滚，</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">是不会回滚的。如果</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">失败回滚，它抛出的异常被</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">捕获，</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">事务仍然可以提交。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="l0zl" id="propagationnotsupported">PROPAGATION_NOT_SUPPORTED</h2><div class="md-section-divider"></div><h3 data-anchor-id="4cim" id="简介-4">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="eojz"><ol class="linenums"><li class="L0"><code><span class="pun">以非事务方式执行操作，如果当前存在事务，就把当前事务挂起</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="joev" id="设计-4">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vpkk"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_NOT_SUPPORTED</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="lz7j" id="案例-3">案例</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qmqm"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，分配一个新事务。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），当执行到</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">的时候，</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的事务挂起，</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">以非事务的状态运行完，再继续</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">的事务。</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="z4rc" id="总结-2">总结</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vqy9"><ol class="linenums"><li class="L0"><code><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">数据操作出现异常不会回滚。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="ecs4" id="propagationnever">PROPAGATION_NEVER</h2><div class="md-section-divider"></div><h3 data-anchor-id="q1l1" id="简介-5">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ay0y"><ol class="linenums"><li class="L0"><code><span class="pun">以非事务方式执行，如果当前存在事务，则抛出异常</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="lkpw" id="设计-5">设计</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5iro"><ol class="linenums"><li class="L0"><code><span class="pun">类</span><span class="typ">ServiceA</span><span class="pun">,方法</span><span class="pln">methodA</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_REQUIRED</span></code></li><li class="L1"><code><span class="pun">类</span><span class="typ">ServiceB</span><span class="pun">,方法</span><span class="pln">methodB</span><span class="pun">,事务级别定义为</span><span class="pln">PROPAGATION_NEVER</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="j1yv" id="案例-4">案例</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5vtt"><ol class="linenums"><li class="L0"><code><span class="pun">先调用</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">，发现没有运行在事务中，分配一个新事务。再调用</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">（这个要写在</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">内部），抛出异常。</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="gebp" id="propagationnested">PROPAGATION_NESTED</h2><div class="md-section-divider"></div><h3 data-anchor-id="tu5n" id="简介-6">简介</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="efat"><ol class="linenums"><li class="L0"><code><span class="pun">理解</span><span class="typ">Nested</span><span class="pun">的关键是</span><span class="pln">savepoint</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="i8xw" id="总结-3">总结</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="kcht"><ol class="linenums"><li class="L0"><code><span class="typ">Nested</span><span class="pun">的事务和它的父事务是相依的，它的提交是要等和它的父事务一块提交的。也就是说，如果父事务最后回滚，它也要回滚的。而</span><span class="typ">Nested</span><span class="pun">事务的好处是它有一个</span><span class="pln">savepoint</span><span class="pun">。也就是说</span><span class="typ">ServiceB</span><span class="pun">.</span><span class="pln">methodB</span><span class="pun">失败回滚，那么</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">也会回滚到</span><span class="pln">savepoint</span><span class="pun">点上，</span><span class="typ">ServiceA</span><span class="pun">.</span><span class="pln">methodA</span><span class="pun">可以选择另外一个分支，比如</span><span class="typ">ServiceC</span><span class="pun">.</span><span class="pln">methodC</span><span class="pun">，继续执行，来尝试完成自己的事务。但是这个事务并没有在</span><span class="pln">EJB</span><span class="pun">标准中定义</span></code></li></ol></pre></div>
</body>
</html>