<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>redis eval</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="pvl2" id="redis-eval">redis eval</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="h2v3" id="设置k-v设置有效期">设置k-v，设置有效期</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oahu"><ol class="linenums"><li class="L0"><code><span class="pln">redis</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="str">'set'</span><span class="pun">,</span><span class="pln"> KEYS</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> ARGV</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="str">'expire'</span><span class="pun">,</span><span class="pln"> KEYS</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> ARGV</span><span class="pun">[</span><span class="lit">2</span><span class="pun">])</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="rrx4" id="incrby设置过期时间返回自增值">incrby，设置过期时间，返回自增值</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="9sf3"><ol class="linenums"><li class="L0"><code><span class="kwd">local</span><span class="pln"> value </span><span class="pun">=</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="str">'incrby'</span><span class="pun">,</span><span class="pln"> KEYS</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> ARGV</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="str">'expire'</span><span class="pun">,</span><span class="pln"> KEYS</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> ARGV</span><span class="pun">[</span><span class="lit">2</span><span class="pun">])</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> value</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="3ayq" id="每日累计次数1返回成功0返回失败">每日累计次数，1返回成功，0返回失败</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="yjdq"><ol class="linenums"><li class="L0"><code><span class="kwd">eval</span><span class="pln"> </span><span class="str">"local key = KEYS[1] </span></code></li><li class="L1"><code><span class="str">local redis_key = KEYS[2] </span></code></li><li class="L2"><code><span class="str">local filed = ARGV[1] </span></code></li><li class="L3"><code><span class="str">local value = ARGV[2] </span></code></li><li class="L4"><code><span class="str">local jsonString = redis.call('hget',key,filed) </span></code></li><li class="L5"><code><span class="str">local json = cjson.decode(jsonString) </span></code></li><li class="L6"><code><span class="str">local redis_value = redis.call('get', redis_key) </span></code></li><li class="L7"><code><span class="str">if redis_value==false then redis_value = 0 end </span></code></li><li class="L8"><code><span class="str">local sum = tonumber(redis_value) + tonumber(value) </span></code></li><li class="L9"><code><span class="str">if (tonumber(sum) &lt;= tonumber(json[ARGV[3]])) then redis.call('set', redis_key, tonumber(sum)) return 1 else return 0 end "</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">{</span><span class="pln">cyq</span><span class="pun">}.</span><span class="pln">tableName </span><span class="pun">{</span><span class="pln">cyq</span><span class="pun">}.</span><span class="pln">maxcount trade</span><span class="pun">.*.*.*</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> maxCount</span></code></li></ol></pre></div>
</body>
</html>