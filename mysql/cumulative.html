<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>动态累加SQL</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="3c58" id="动态累加sql">动态累加SQL</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="71rk" id="获取金额多条数据累加值不超过输入值">获取金额多条数据累加值不超过输入值</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v76w"><ol class="linenums"><li class="L0"><code><span class="pln">SELECT </span></code></li><li class="L1"><code><span class="pln">  t</span><span class="pun">.*</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">FROM</span></code></li><li class="L3"><code><span class="pln">  </span><span class="pun">(</span><span class="pln">SELECT </span></code></li><li class="L4"><code><span class="pln">    user_recharge_address</span><span class="pun">.*,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">(</span><span class="lit">@sum</span><span class="pln"> </span><span class="pun">:=</span><span class="pln"> </span><span class="lit">@sum</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">)</span><span class="pln"> AS cumulative_balance </span></code></li><li class="L6"><code><span class="pln">  FROM</span></code></li><li class="L7"><code><span class="pln">    </span><span class="str">`user_recharge_address`</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">    </span><span class="pun">(</span><span class="pln">SELECT </span><span class="lit">@sum</span><span class="pln"> </span><span class="pun">:=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">params</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">  WHERE coin_code </span><span class="pun">=</span><span class="pln"> </span><span class="str">'BTC'</span><span class="pln"> ORDER BY </span><span class="str">`balance`</span><span class="pln"> DESC</span><span class="pun">,</span><span class="pln"> </span><span class="str">`ID`</span><span class="pun">)</span><span class="pln"> t </span></code></li><li class="L0"><code><span class="pln">WHERE cumulative_balance </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> OR </span><span class="pun">(</span><span class="pln">cumulative_balance </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> AND cumulative_balance </span><span class="pun">-</span><span class="pln"> balance </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">10</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="5dtt" id="例子">例子</h2><div class="md-section-divider"></div><h3 data-anchor-id="d2vz" id="创建表">创建表</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="e2b0"><ol class="linenums"><li class="L0"><code><span class="pln">CREATE TABLE </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">  </span><span class="str">`ID`</span><span class="pln"> INT</span><span class="pun">(</span><span class="lit">11</span><span class="pun">)</span><span class="pln"> NOT NULL AUTO_INCREMENT COMMENT </span><span class="str">'记录id，自增长'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">  </span><span class="str">`user_id`</span><span class="pln"> INT</span><span class="pun">(</span><span class="lit">11</span><span class="pun">)</span><span class="pln"> NOT NULL COMMENT </span><span class="str">'用户ID'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">  </span><span class="str">`coin_code`</span><span class="pln"> VARCHAR</span><span class="pun">(</span><span class="lit">6</span><span class="pun">)</span><span class="pln"> NOT NULL COMMENT </span><span class="str">'币种，RMB-人民币  BTC-比特币 ETH-以太币'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">  </span><span class="str">`url`</span><span class="pln"> VARCHAR</span><span class="pun">(</span><span class="lit">42</span><span class="pun">)</span><span class="pln"> NOT NULL COMMENT </span><span class="str">'充值地址'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">  </span><span class="str">`balance`</span><span class="pln"> DECIMAL</span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> DEFAULT </span><span class="str">'0.00000000'</span><span class="pln"> COMMENT </span><span class="str">'余额'</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">  </span><span class="str">`blocked`</span><span class="pln"> DECIMAL</span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> DEFAULT </span><span class="str">'0.00000000'</span><span class="pln"> COMMENT </span><span class="str">'冻结额'</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">  </span><span class="str">`create_time`</span><span class="pln"> TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT </span><span class="str">'创建时间'</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">  PRIMARY KEY </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pun">)</span><span class="pln"> ENGINE</span><span class="pun">=</span><span class="pln">INNODB DEFAULT CHARSET</span><span class="pun">=</span><span class="pln">utf8 COMMENT</span><span class="pun">=</span><span class="str">'用户充币地址表'</span><span class="pun">;</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="uc7l" id="添加测试数据">添加测试数据</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rmqx"><ol class="linenums"><li class="L0"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'1'</span><span class="pun">,</span><span class="str">'6'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'123456_test'</span><span class="pun">,</span><span class="str">'3.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 10:35:44'</span><span class="pun">);</span></code></li><li class="L1"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'11'</span><span class="pun">,</span><span class="str">'2'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'123456_test1'</span><span class="pun">,</span><span class="str">'1.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 10:35:44'</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'12'</span><span class="pun">,</span><span class="str">'3'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'123456_test12'</span><span class="pun">,</span><span class="str">'3.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 10:35:44'</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'13'</span><span class="pun">,</span><span class="str">'11'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'123456_test121'</span><span class="pun">,</span><span class="str">'3.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 10:35:44'</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'14'</span><span class="pun">,</span><span class="str">'12'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'123456_test1211'</span><span class="pun">,</span><span class="str">'1.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 10:35:44'</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">INSERT INTO </span><span class="str">`user_recharge_address`</span><span class="pln"> </span><span class="pun">(</span><span class="str">`ID`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`user_id`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`coin_code`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`url`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`balance`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`blocked`</span><span class="pun">,</span><span class="pln"> </span><span class="str">`create_time`</span><span class="pun">)</span><span class="pln"> VALUES</span><span class="pun">(</span><span class="str">'4'</span><span class="pun">,</span><span class="str">'1'</span><span class="pun">,</span><span class="str">'BTC'</span><span class="pun">,</span><span class="str">'XXXX'</span><span class="pun">,</span><span class="str">'3.00000000'</span><span class="pun">,</span><span class="str">'0.00000000'</span><span class="pun">,</span><span class="str">'2017-09-15 11:01:54'</span><span class="pun">);</span></code></li></ol></pre></div>
</body>
</html>